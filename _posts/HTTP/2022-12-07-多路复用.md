---
layout:     post
title:      多路复用
subtitle:  
date:       2022-12-07
author:     
header-img: 
catalog: true
tags:
  - HTTP相关内容
typora-root-url: ..

---

# 多路复用

## HTTP 1.0

一个 http 请求需要发起一个 tcp 链接，一个 http 请求结束之后才能相应下一个 http 请求，这样会导致后面的请求响应速度很慢。如果一个 http 请求发生意外（比如丢包、服务器响应缓慢），就会导致后面的请求延迟。这种情况称为**对头阻塞**。

一次请求完成就会关闭本次的 Tcp 连接，下个请求又要从新建立 Tcp 连接传输完成数据再关闭，造成很大的性能损耗。

为了解决这个问题，浏览器会对同一个域名建立多个 TCP 连接，来实现 HTTP 的并发，同一个域名下 TCP 连接数最多会在 6 ~ 8 个左右。

如果网页一次性加载的资源太多，比如大量图片，6 个 TCP 连接数可能也会顶不住。为了解决一个问题，我们会使用 **域名分片**（Domain sharding） 的方法，就是将资源放到不同的域名下。

## HTTP 1.1

#### 连接复用 Keep-alive 

一次连接，可以有多个请求响应。

##### 存在问题

- 串行的文件传输

- 同域并行请求限制带来的阻塞（6~8）个

#### Pipeline 传输

下一次的请求不需要等待上一个响应来之后再发送。响应的顺序是不变的，FIFO（先进先出）。

##### 存在的问题

- 请求是按次序的，后来者需要排队等待，依然有阻塞问题

- 请求头大多类似，重复传输浪费资源

- 同一域名的浏览器有最大并行请求限制

## HTTP 2

#### 多路复用

背景：HTTP 1.X 是基于文本的，因为是文本，就导致了它必须是个整体，在传输是不可切割的，只能整体去传。但 HTTP 2.0 是基于二进制流的，将 HTTP 消息分解为独立的帧，交错发送，然后在另一端重新组装。

帧：最小的数据单位，每个帧会标识出该帧属于哪个流。

流：多个帧组成的数据流。

##### 优点

**同一个TCP连接中，同一时刻可以发送多个请求和响应，且不用按照顺序一一对应**

**同域名下所有通信都在单个连接上完成，同个域名只需要占用一个 TCP 连接，使用一个连接并行发送多个请求和响应**。

**数据流以消息的形式发送，而消息又由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装。每个请求都可以带一个 31bit 的优先值，0 表示最高优先级， 数值越大优先级越低**。
