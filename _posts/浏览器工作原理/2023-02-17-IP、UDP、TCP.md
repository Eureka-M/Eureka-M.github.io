---
layout:     post
title:      IP、UDP、TCP
subtitle:  
date:       2023-02-17
author:     
header-img: 
catalog: true
tags:
  - 浏览器工作原理
typora-root-url: ..
---



# IP、UDP、TCP

## IP

把数据包送达目的主机。

一个数据包从主机 A 到主机 B 的旅程：

<img src="/../img/postImage/image-20230217145200907.png" alt="image-20230217145200907" style="zoom: 33%;" />



- 上层将含有“极客时间”的数据包交给网络层。
- 网络层再将 IP 头附加到数据包上，组成新的 IP 数据包，并交给底层（IP 头是 IP 数据包开头的信息，包含 IP 版本、源 IP 地址、目标 IP 地址、生存时间等信息。）。
- 底层通过物理网络将数据包传输给主机 B。
- 数据包被传输到主机 B 的网络层，在这里主机 B 拆开数据包的 IP 头信息，并将拆开来的数据部分交给上层。

最终，含有“极客时间”信息的数据包就到达了主机 B 的上层了。



## UDP

IP 通过 IP 地址信息把数据包发送给指定的电脑，而 UDP 通过端口号把数据包分发给正确的程序。

> IP 头一样，端口号会被装进 UDP 头里面，UDP 头再和原始数据包合并组成新的 UDP 数据包。UDP 头中除了目的端口，还有源端口号。

加上UDP之后，下一个数据包从主机 A 旅行到主机 B 的路线：

<img src="/../img/postImage/image-20230217164513071.png" alt="image-20230217164513071" style="zoom: 50%;" />

- 上层将含有“极客时间”的数据包交给传输层；
- 传输层会在数据包前面附加上 UDP 头，组成新的 UDP 数据包，再将新的 UDP 数据包交给网络层；
- 网络层再将 IP 头附加到数据包上，组成新的 IP 数据包，并交给底层；
- 数据包被传输到主机 B 的网络层，在这里主机 B 拆开 IP 头信息，并将拆开来的数据部分交给传输层；
- 在传输层，数据包中的 UDP 头会被拆开，并根据 UDP 中所提供的端口号，把数据部分交给上层的应用程序；

最终，含有“极客时间”信息的数据包就旅行到了主机 B 上层应用程序这里。

虽然UDP 可以校验数据是否正确，但是对于错误的数据包，UDP 并**不提供重发机制**，只是丢弃当前的包，而且 UDP 在发送之后也无法知道是否能达到目的地。**UDP 不能保证数据可靠性，但是传输速度却非常快**。



## TCP

把数据完整地送达应用程序。TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。

> TCP 提供重传机制，保证数据包不会丢失。引入了数据包排序机制，用来保证把乱序的数据包组合成一个完整的文件。
>
> 和 UDP 头一样，TCP 头除了包含了目标端口和本机端口号外，还提供了用于排序的序列号，以便接收端通过序号来重排数据包。

TCP 下的单个数据包的传输流程：

<img src="/../img/postImage/image-20230217171558283.png" alt="image-20230217171558283" style="zoom:50%;" />



完整的 TCP 连接过程：

<img src="/../img/postImage/image-20230217173504080.png" alt="image-20230217173504080" style="zoom:50%;" />

> TCP 为了保证数据传输的可靠性，牺牲了数据包的传输速度，因为“三次握手”和“数据包校验机制”等把传输过程中的数据包的数量提高了一倍。



## 问题和答案



Q：怎么理解 HTTP 和 TCP 的关系？

A：HTTP协议和TCP协议都是TCP/IP协议簇的子集。HTTP协议属于应用层，TCP协议属于传输层，HTTP协议位于TCP协议的上层。请求方要发送的数据包，在应用层加上HTTP头以后会交给传输层的TCP协议处理，应答方接收到的数据包，在传输层拆掉TCP头以后交给应用层的HTTP协议处理。建立 TCP 连接后会顺序收发数据，请求方和应答方都必须依据 HTTP 规范构建和解析HTTP报文。



Q：浏览器可以同时打开多个页签，他们端口一样吗？如果一样，数据怎么知道去哪个页签？

A：端口一样的，网络进程知道每个tcp链接所对应的标签是那个，所以接收到数据后，会把数据分发给对应的渲染进程。



Q：TCP传送数据时 浏览器端就做渲染处理了么？如果前面数据包丢了 后面数据包先来是要等么？类似的那种实时渲染怎么处理？针对数据包的顺序性？

A：接收到http响应头中的content-type类型时就开始准备渲染进程了，响应体数据一旦接受到便开始做DOM解析了！基于http不用担心数据包丢失的问题，因为丢包和重传都是在tcp层解决的。http能保证数据按照顺序接收的（也就是说，从tcp到http的数据就已经是完整的了，即便是实时渲染，如果发生丢包也得在重传后才能开始渲染）



Q：关于 "数据在传输的过程中有可能会丢失或者出错"，丢失的数据包去哪里了？凭空消失了吗？出错的数据包又变成啥了？ 为什么会出错？

A：比如网络波动，物理线路故障，设备故障，恶意程序拦截，网络阻塞等等