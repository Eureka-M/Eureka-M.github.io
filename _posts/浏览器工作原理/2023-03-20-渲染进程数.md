---
layout:     post
title:      渲染进程数
subtitle:  
date:       2023-03-20
author:     
header-img: 
catalog: true
tags:
  - 浏览器工作原理
typora-root-url: ..
---

- 在默认情况下，如果打开一个标签页，那么浏览器会默认为其创建一个渲染进程。
- 如果从一个标签页中打开了另一个标签页，当新标签页和当前标签页属于**同一站点 (相同协议、相同根域名)** 的话，那么新标签页会复用当前标签页的渲染进程。
- 但是如果是分别打开这两个标签页，这个时候浏览器还是会创建两个渲染进程。

那既然都是同一站点，为什么从 A 标签页中打开 B 标签页，就会使用同一个渲染进程，而分别打开这两个标签页，又会分别使用不同的渲染进程？

### 标签页之间的连接

浏览器标签页之间是可以通过 JavaScript 脚本来连接的，有以下几种方式：

- 通过`<a>`标签来和新标签建立连接

    这种方式，新标签页中的 `window.opener` 的值就会指向当前标签页中的window。表明这两个标签页是有连接的。

- 通过 `window.open` 和新标签建立连接

    这种方式，可以在当前标签页中通过 `new_window` 来控制新标签页，还可以在新标签页中通过 `window.opener` 来控制当前标签页。表明这两个标签页也是有连接的。

上述两种方式打开的新标签页，无论是否属于同一站点，他们之间都能通过 opener 来建立连接，所以他们之间是有联系的。这类具有相互连接关系的标签页称为 **浏览上下文组**。

我们把一个标签页所包含的内容，诸如 window 对象，历史记录，滚动条位置等信息称为**浏览上下文**。这些通过脚本相互连接起来的浏览上下文就是**浏览上下文组**。

**Chrome 浏览器会将浏览上下文组中`属于同一站点`的标签分配到同一个渲染进程中**。因为如果一组标签页，既在同一个浏览上下文组中，又属于同一站点，那么它们可能需要在对方的标签页中执行脚本。因此，它们必须运行在同一渲染进程中。

下图为  Chrome 浏览器为标签页分配渲染进程的策略：

![image-20230320205516809](/../img/postImage/image-20230320205516809.png)

### 一个“例外”？

留言区中，ID 为“芳华年月”的朋友就提出了这样的一个问题：

首先打开 linkmarket.aliyun.com 这个标签页，再在这个标签页中随便点击两个链接，然后就打开了两个新的标签页了，但是A、B、C 三个标签页分别使用了三个不同的渲染进程？

<img src="/../img/postImage/image-20230320210017167.png" alt="image-20230320210017167" style="zoom:50%;" />

既然属于同一站点，又不在同一个渲染进程中，所以可以推断这三个标签页不属于同一个浏览上下文组，那么我们接下来的分析思路就很清晰了：

1. 首先验证这三个标签页是不是真的不在同一个浏览上下文组中
2. 然后再分析它们为什么不在同一浏览上下文组

```
打开控制台，查看 B 标签页和 C 标签标签页的 opener 的值，结果发现这两个标签页中的 opener 的值都是 null，这就确定了 B、C 标签页和 A 标签页没有连接关系，当然也就不属于同一浏览上下文组了。
```

<img src="/../img/postImage/image-20230320221607587.png" alt="image-20230320221607587" style="zoom:50%;" />

a 链接的 rel 属性值都使用了 `noopener` 和 `noreferrer`，通过noopener，我们能猜测得到这两个值是让被链接的标签页和当前标签页不要产生连接关系。

> 将 noopener 的值引入 rel 属性中，就是告诉浏览器通过这个链接打开的标签页中的 opener 值设置为 null，引入 noreferrer 是告诉浏览器，新打开的标签页不要有引用关系。

### 站点隔离

Chrome 站点隔离是一种安全机制，它可以防止恶意网站通过共享同一进程的方式攻击其他网站。通过启用站点隔离，该技术可以将每个网站的渲染进程独立分离，并使用不同的进程进行管理。这样，当一个网站被攻击时，恶意代码只会影响该网站的进程，而不会影响其他网站的进程。

> Chrome 站点隔离的启用方式是通过在 Chrome 浏览器中启用“Strict Site Isolation”（严格站点隔离）选项。这个选项可以在 Chrome 浏览器的“chrome://flags”页面中找到，并将其设置为“Enabled”。
>

Chrome 浏览器已经默认实现了站点隔离的功能，这意味着标签页中的 `iframe` 也会遵守同一站点的分配原则，如果标签页中的 `iframe` 和`标签页`是`同一站点，并且有连接关系`，那么标签页依然会和当前标签页运行在同一个渲染进程中，如果 iframe 和标签页不属于同一站点，那么 iframe 会运行在单独的渲染进程中。

下图表明了 iframe 是如何计算所使用渲染进程数的

<img src="/../img/postImage/image-20230320222206892.png" alt="image-20230320222206892" style="zoom:50%;" />

### Q & A

Q: 

Chrome 为什么使用同一站点划分渲染进程，而不是使用同源策略来划分渲染进程？

A：

同源策略只考虑了安全因素，而未考虑到性能因素。

同源策略会将不同域名的网站划分为不同的进程，这会导致在一个页面内加载多个同源但不同域名的资源时，每个资源都需要单独的进程，增加了进程间的通信和内存开销，降低了性能。

而同一站点划分渲染进程则可以将同一站点的所有资源都放在同一个进程中，避免了进程间通信和内存开销，提高了性能。

同一站点划分渲染进程也可以提高网页加载速度和用户体验。在同一站点的页面之间切换时，不需要重新创建进程和加载资源，可以快速切换，提高用户体验。