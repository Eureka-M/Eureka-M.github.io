---
layout:     post
title:      chrome浏览器多进程架构
subtitle:  
date:       2023-02-16
author:     
header-img: 
catalog: true
tags:
  - 浏览器工作原理
typora-root-url: ..
---

# chrome浏览器多进程架构

## 进程和线程

### 定义和概念

- 多线程可以并行处理任务，但是线程不能单独存在，它是由进程来进行启动和管理的。


- 启动一个程序的时候，操作系统会为该程序创建一块`内存`，用来存放代码、运行中的数据和一个执行任务的主线程，这样的一个`运行环境`叫进程。


- 进程中任意线程执行出错，都会导致进程的奔溃。


- 线程之间可以共享进程的数据。


- 当一个进程关闭之后，操作系统会回收进程所占用的内存，即使其中任意线程因为操作不当导致内存泄漏，当进程退出时，这些内存也会被正确回收。


- 进程之间的内容是相互隔离的。所以一个进程如果崩溃了，或者挂起了，是不会影响到其他进程的。如果进程之间需要进行数据的通信，这时候，就需要使用用于进程间通信（IPC）的机制了。


## 浏览器的发展

### 单进程时代

<img src="/../img/postImage/image-20230216192213330.png" alt="image-20230216192213330" style="zoom:50%;" />

三个缺点：不稳定、不流畅、不安全、内存泄露。

**不稳定**：任意一个模块出错都会导致浏览器的奔溃。

**不流畅**：比如说一个模块死循环，会阻塞导致线程中其他模块无法执行。整个浏览器就会卡顿，失去响应，最后奔溃。

**不安全**：单进程浏览器架构，插件和页面脚本可以通过漏洞对接操作系统，如果是个恶意插件，那么它就可以释放病毒、窃取你的账号密码，引发安全性问题。

**内存泄露**：运行一个复杂点的页面再关闭页面，会存在内存不能完全回收的情况，这样导致的问题是使用时间越长，内存占用越高，浏览器会变得越慢。

### 早期多进程时代

<img src="/../img/postImage/image-20230216193412933.png" alt="image-20230216193412933" style="zoom:50%;" />

Chrome 的页面是运行在单独的渲染进程中的，同时页面里的插件也是运行在单独的插件进程之中，而进程之间是通过 IPC 机制进行通信的。

**解决单进程的问题**：

不安全：进程间的相互隔离，页面或者插件奔溃时，不会影响到其他页面。

不流畅：每个脚本阻塞只会影响当前的页面，只会是的当前这个页面无法响应，浏览器不会奔溃。

不安全：Chrome 把插件进程和渲染进程锁在沙箱里面，这样即使在渲染进程或者插件进程里面执行了恶意程序，恶意程序也无法突破沙箱去获取系统权限。（沙箱：操作系统给进程上了一把锁，沙箱里面的程序可以运行，但是不能在你的硬盘上写入任何数据，也不能在敏感位置读取任何数据。）

内存泄漏：当关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收。

### 目前多进程时代

<img src="/../img/postImage/image-20230216194720717.png" alt="image-20230216194720717" style="zoom: 50%;" />

最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

**浏览器进程**：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。

**渲染进程**：核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。

**GPU 进程**：其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。

**网络进程**：主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。

**插件进程**：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

> 多进程模型提升了浏览器的稳定性、流畅性和安全性，但同样带来了一些问题：更高的资源占用，更复杂的体系架构。
>

### 未来面向服务的架构

未来，Chrome 整体架构会朝向现代操作系统所采用的“面向服务的架构（SOA：Services Oriented Architecture）” 方向发展原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统，更好实现 Chrome 简单、稳定、高速、安全的目标。

Chrome 最终要把 UI、数据库、文件、设备、网络等模块重构为基础服务，类似操作系统底层服务。

![image-20230216195227398](/../img/postImage/image-20230216195227398.png)