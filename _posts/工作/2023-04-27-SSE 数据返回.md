---
layout:     post
title:      SSE æ•°æ®è¿”å›
subtitle:  
date:       2023-04-27
author:     
header-img: 
catalog: true
tags:
  - å·¥ä½œ
typora-root-url: ..
---

### èƒŒæ™¯

æœ€è¿‘æ­£åœ¨åš AI åŠ©æ‰‹è¿™ä¸ªéœ€æ±‚ï¼ŒåŸæœ¬é‡‡ç”¨æ™®é€šçš„ json è¿”å›ï¼Œåæ¥è§‰å¾—è¿™ç§æ–¹å¼è¯·æ±‚çš„æ—¶é—´å¤ªé•¿äº†ï¼Œè¿”å›å†…å®¹å¤ªå¤šçš„è¯å¯èƒ½éœ€è¦ä¸‰å››åç§’ï¼Œç”¨æˆ·ä½“éªŒä¸å¥½ï¼Œäºæ˜¯ä¹æ¢æˆäº† SSEã€‚

### SSE

SSEï¼ˆServer Send Eventsï¼‰ï¼šæœåŠ¡å™¨å‘é€äº‹ä»¶ (SSE) æ˜¯ä¸€ç§ç®€å•çš„æŠ€æœ¯ï¼Œç”¨äºä¸ºç‰¹å®šçš„ Web åº”ç”¨ç¨‹åºå®ç°æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„å¼‚æ­¥é€šä¿¡ã€‚ æ˜¯ä¸€ç§åœ¨åŸºäºæµè§ˆå™¨çš„ Web åº”ç”¨ç¨‹åºä¸­ä»…ä»æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ–‡æœ¬æ¶ˆæ¯çš„æŠ€æœ¯ã€‚SSEåŸºäº HTTP åè®®ä¸­çš„æŒä¹…è¿æ¥ï¼Œ å…·æœ‰ç”± W3C æ ‡å‡†åŒ–çš„ç½‘ç»œåè®®å’Œ EventSource å®¢æˆ·ç«¯æ¥å£ï¼Œä½œä¸º HTML5 æ ‡å‡†å¥—ä»¶çš„ä¸€éƒ¨åˆ†ã€‚

### SSEç½‘ç»œåè®®

å®¢æˆ·ç«¯ï¼š

Accept: text/event-stream è¡¨ç¤ºå¯æ¥æ”¶äº‹ä»¶æµç±»å‹

Cache-Control: no-cache ç¦ç”¨ä»»ä½•çš„äº‹ä»¶ç¼“å­˜

Connection: keep-alive è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨æŒä¹…è¿æ¥

æœåŠ¡å™¨ï¼š

Content-Type: text/event-stream;charset=UTF-8 è¡¨ç¤ºæ ‡å‡†è¦æ±‚çš„äº‹ä»¶çš„åª’ä½“ç±»å‹å’Œç¼–ç 

Transfer-Encoding: chunked è¡¨ç¤ºæœåŠ¡å™¨æµå¼ä¼ è¾“åŠ¨æ€ç”Ÿæˆçš„å†…å®¹

è®¢é˜…åï¼ŒæœåŠ¡ç«¯åœ¨æ¶ˆæ¯å¯ç”¨æ—¶ç«‹å³å‘é€ç»™å®¢æˆ·ç«¯ã€‚äº‹ä»¶æ˜¯é‡‡ç”¨ UTF-8 ç¼–ç çš„æ–‡æœ¬æ¶ˆæ¯ã€‚äº‹ä»¶ä¹‹é—´ç”±ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš”\n\nã€‚æ¯ä¸ªäº‹ä»¶ç”±ä¸€ä¸ªæˆ–å¤šä¸ªåç§°ï¼šå€¼å­—æ®µç»„æˆï¼Œç”±å•ä¸ªæ¢è¡Œç¬¦\n åˆ†éš”ã€‚ 

### SSE ä½¿ç”¨

```
var eventSource = new EventSource('/sse')
```

**é—®é¢˜1**ï¼šè¿”å›çš„å†…å®¹åœ¨å‰ç«¯çš„è¡¨ç°æ˜¯ç­‰å¾…å¾ˆé•¿ä¸€æ®µæ—¶é—´ä¹‹åä¸€æ¬¡æ€§è¿”å›ï¼Œä¸æ˜¯æµå¼è¿”å›ã€‚ä½†æ˜¯ä½¿ç”¨ curl è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ç¡®å®æ˜¯æŒ‰ç…§æµå¼è¿”å›çš„ã€‚

**è§£å†³**ï¼š

<u>æ–¹æ¡ˆ1</u>ï¼šå…³é—­ webpack çš„ compressã€‚

![image-20230504165124588](/../img/postImage/image-20230504165124588.png)

è€ƒè™‘åˆ° compress è¿˜æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§ï¼Œä½¿ç”¨äº†æ–¹æ¡ˆ2æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

<u>æ–¹æ¡ˆ2</u>ï¼š

ä½¿ç”¨ 'Cache-Control': 'no-transform' ä½¿å¾—å“åº”ä¸åšä»»ä½•è½¬å˜ã€‚é¿å… webpack çš„å‹ç¼©ã€‚

```
'Cache-Control': 'no-transform'
```

**é—®é¢˜2**ï¼šè¯·æ±‚æ›´æ”¹å‚æ•°ï¼Œéœ€è¦ä¼ é€’ formData å‚æ•°ï¼Œä½†æ˜¯ EventSource å¹¶ä¸æ”¯æŒ post è¯·æ±‚ã€‚

<u>æ–¹æ¡ˆ1</u>:  [fetch-event-source](https://github.com/Azure/fetch-event-source)

```
fetchEventSource('/api/sse', {
    method: 'POST',
    headers: {
    	'Accept': 'text/event-stream',
        'Content-Type': 'formdata',
    },
    body: JSON.stringify({
        foo: 'bar'
    })
});
```

<u>æ–¹æ¡ˆ2</u>ï¼šfetch

```
 fetch('/api/sse', {
     method: 'POST',
     headers: {
         'Accept': 'text/event-stream',
         'Cache-Control': 'no-transform'
     },
     body: form,
  }).then(async (response) => {
     const reader = response.body.getReader()
     const decoder = new TextDecoder()

     // è¯»å–å¹¶å¤„ç†SSEæ•°æ®
     while (true) {
         const { value, done } = await reader.read()

         if (done) {
         	break
         }

         const decodedValue = decoder.decode(value)
         console.log(decodedValue) // ä¸€æ¡ä¸€æ¡çš„æ‰“å°
     }
 })
```

æœ€ç»ˆé€‰æ‹©äº†æ–¹æ¡ˆ2ï¼Œæ¯•ç«Ÿå¯ä»¥å°‘å®‰è£…ä¸€ä¸ªåŒ…ğŸ˜†ã€‚